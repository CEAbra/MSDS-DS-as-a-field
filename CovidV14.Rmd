---
title:
  "Covid Data Analysis: Deaths associated to Covid-19 per thousand inhabitants in US counties depend on the population size depending of the Region"
author:
  "CA"
output:
  pdf_document
fontsize:
  12pt
date: "2025-03-28"
---
List of libraries used: - tidyverse - car - broom - readxl

# Summary

In this project, I used the US Covid-19 Data Analysis for the period 2020-2023 available in the COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University:

https://github.com/CSSEGISandData/COVID-19/tree/4360e50239b4eb6b22f3a1759323748f36752177.

I explored if the cumulative deaths associated to Covid-19 per thousand inhabitants in US counties recorded until 2023-03-09 showed a correlation with the number of people per county and if this changes with the region to which the cities belong according to the US Census Bureau.    

# Objectives:

- To explored if the cumulative deaths associated to Covid-19 per thousand inhabitants in US counties recorded until 2023-03-09 showed a correlation with the number of people per counties

- To explored if the cumulative confirmed cases associated to Covid-19 per thousand inhabitants in US counties recorded until 2023-03-09 depended on the region to which the county is located.


# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set the seed to generate the same random sequence of pseudo-numbers each time that this code is run. This ensures reproducibility.

set.seed(143)
```

## Load libraries

```{r libraries}
# Load libraries

library(tidyverse)
library(car)
library(broom)
library(knitr)

```

## Load data and data wrangling

For this project, I used the columns with information about:

- Count (Admin2 column)
- State or US territory (Province_State column)
- Population 
- Cumulative deaths from the last day recorded in the dataset

```{r covid-data-load}

# Create a string with the url to download the data with deaths by Covid-19 in US

url.deaths = c('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv')

```

 
```{r load-data}
# Create a function to download data (only the columns needed)  

wrangle_data <- function(x){
  y <- read_csv(x, col_select = c('Admin2',
            'Province_State',
            'Population',
            '3/9/23'))
}

# Download death data

mortality <- wrangle_data(url.deaths) 

# Free memory
gc()
```

## Data description

Because of the data structure, I printed only the description of the first columns

```{r data-description}

summary(mortality[,1:4])

```

During the inspection of data, I noted that some counties have zero population so I removed them in the next section. 
In addition, I studied the reliability of the data by calculating the new deaths per day. 
Some counties showed negative number. Given the high number of occurences of this problem, I decided to keep the all the information.


Note: I added the code as an appendix in case you want to run it but it is memory consuming so run it if you want.


## Data Wrangling

In this sections:

- I renamed some features to help data analysis. 

- I removed the counties that have zero population as it was indicated in the summary description above.

- I pivoted the table to tidy the data so each day and Admin2 (County) is one observation per row.

- I transformed the new variable date to a 'date type'

```{r renaming}

# Renaming features
mortality <- mortality %>%
  rename(State = 'Province_State') %>%
# Filter counties with zero population
  filter(!Population == 0) %>%
# Pivot the tibble to create a new feature with days and a new column with deaths 
  pivot_longer(cols = -c('State', 'Admin2','Population'),
               names_to = 'date',
               values_to = 'deaths') %>%
# Transform date column to date type
  mutate(date = as.Date(date,
                     tz = '',
                     tryFormats = '%m/%d/%y')) %>%
# Create deaths per thousand variable
  mutate(
    deaths.per.thou = 1000 * deaths/Population,
  )

# Free memory
gc()

```
# Create a new variable with the region where the County was located

I create a new variable and assigned a region to each state and US territory.
based on the information available at:

https://www2.census.gov/programs-surveys/bps/technical-documentation/code-lists/states-by-region.pdf

|Region             | State or US territory                             |
|-------------------| --------------------------------------------------|
|New England        | Connecticut, Maine, Massachusetts                 |
|                   | New Hampshire, Rhode Island, Vermont              |
|Mid-Atlantic       | New York, New Jersey, Pennsylvania                |
|East South Central | Alabama, Kentucky, Mississippi, Tennessee         |
|South-Atlantic     | Florida, Georgia, North Carolina, South Carolina  |
|                   | Virginia, West Virginia, Maryland                 | 
|                   |Delaware, District of Columbia                     |
|West South Central | Arkansas, Louisiana, Oklahoma, Texas              |
|East North Central | Illinois, Indiana, Michigan, Ohio, Wisconsin      |
|West North Central | Iowa, Kansas, Minnesota, Missouri, Nebraska       |
|                   | North Dakota, South Dakota                        |
|East Middle        | Arizona, Colorado, Idaho, Montana, Nevada         |
|                   | New Mexico, Utah, Wyoming                         |
|East Pacific       | Washington, Oregon, California, Hawaii, Alaska    |

Note: Unfortunately, the data was in a pdf document so I had to type it.

```{r region-variable}

isl.area = c('American Samoa',
             'Guam',
             'Northern Mariana Islands',
             'Puerto Rico',
             'Virgin Islands')

new.eng = c('Connecticut',
            'Maine',
            'Massachusetts',
            'New Hampshire',
            'Rhode Island',
            'Vermont')

mid.a = c('New York',
            'New Jersey',
            'Pennsylvania')


east.sc = c('Alabama',
            'Kentucky',
            'Mississippi',
            'Tennessee')

south.a = c('Florida',
            'Georgia',
            'North Carolina',
            'South Carolina', 
            'Virginia',
            'West Virginia',
           'Maryland',
           'Delaware',
          'District of Columbia')


west.sc = c('Arkansas',
               'Louisiana',
               'Oklahoma',
               'Texas')

east.nc = c('Illinois',
                       'Indiana',
                       'Michigan',
                       'Ohio',
                       'Wisconsin')

west.nc = c('Iowa',
             'Kansas',
                       'Minnesota',
                       'Missouri',
                       'Nebraska',
                       'North Dakota',
                       'South Dakota')

east.m = c('Arizona',
             'Colorado',
             'Idaho',
             'Montana',
             'Nevada',
             'New Mexico',
             'Utah',
             'Wyoming')

east.p = c('Washington',
           'Oregon',
           'California',
           'Hawaii',
           'Alaska')

isl.area = c('American Samoa',
             'Guam',
             'Northern Mariana Islands',
             'Puerto Rico',
             'Virgin Islands')

finaldata <- mortality %>%
  mutate(region = case_when(
    State %in% new.eng ~'New England',
    State %in% mid.a ~ 'Mid-Atlantic',
    State %in% east.sc ~ 'East South Central',
    State %in% south.a ~ 'South-Atlantic',
    State %in% west.sc ~ 'West South Central',
    State %in% east.nc ~ 'East North Central',
    State %in% west.nc ~ 'West North Central',
    State %in% east.m ~ 'East Middle',
    State %in% east.p ~ 'East Pacific',
    State %in% isl.area ~ 'Island Areas')
)


```


# Data visualization

I graphed the deaths associated to Covid-19 per thousand of people per Population depending in the region where the county is located.

The distribution of population size of counties in US indicates that a logaritm transformation of this variable is appropiate for analysis.

```{r pop-distribution}
# Plot distribution of population variable

ggplot(data = finaldata,
       aes(x = Population)) + geom_histogram(fill = 'burlywood', 
                                             color = 'black') +
  ggtitle('Distribution of Population size of counties before transformation')


ggplot(data = finaldata,
       aes(x = log10(Population))) + geom_histogram(fill = 'burlywood', 
                                                    color = 'black') +
  ggtitle('Distribution of Population size of counties after transformation')

```

```{r}

ggplot(data = finaldata,
       aes(x = log10(Population),
           y = deaths.per.thou)) +
  geom_point() +
  facet_wrap(.~ region,
             ncol = 5) +
  theme(panel.background = element_rect(fill = 'gray'),
        panel.grid.major = element_blank(),
        axis.line = element_line(color = 'black')) +
  ylab('Deaths per thousand people') +
  xlab('log10(Population)') +
  ggtitle('Deaths associated to Covid-19 per thousand of people per Population')

```


Conclusion: The number of deaths caused by Covid-19 per thousand of people in a county registered until 2023-03-09 seems to depend in part of the population size of a county and the region where it is located.

# Model

In the this section I tested if in the number of deaths by Covid-19 per thousand of people of a county was statistically correlated with the number of people depending of the region. I used a linear regression model followed by Two Way Analysis of Variance (ANOVA) with interaction (because after inspecting the graph above, I realized that the slope of the possible correlation seems to change depending on the region).

Note: I built this model for explanation, not for prediction.

```{R}
# Convert Region variable to factor
finaldata$region <- factor(finaldata$region)

# Assign a region to be the level. I choose East Middle because it seemed that there was not correlation between deaths per thousand and population size.
finaldata$region <- relevel(finaldata$region, ref = 'East Pacific')

# Linear model with regression
model <- finaldata %>%
  lm(formula = deaths.per.thou ~ log10(Population) * region,
                   contrasts = list(
                     region = contr.sum)) %>%
  Anova(type = 3)

kable(model,
      caption = 'Anova test of the Linear Regression Model for Covid-19 death/thousand of people by County and US Region')

```

Both factors, population size and region, and the interaction term showed to be significant so I included them in the final model. All the term resulted significant.

```{r}

model <- finaldata %>%
  lm(formula = deaths.per.thou ~ log10(Population) * region) %>%
  tidy(conf.int = TRUE)

# Print results
kable(model,
      caption = 'Linear Regression Model for Covid-19 death per thousand of people by County and US Region',
      digits = 3)

kable(model[!(model$conf.low < 0 & model$conf.high > 0), ], 
      caption = 'RESULTS: Table of Significant Terms of Linear Regression Model for Covid-19 death per thousand of people by County and US Region',
      digits = 3) 


```

# Final Visualization

To make easier the interpretation of the results, I plotted the original graphs and the linear regression model results. 

Note: the model seemed to not do a good job modelling the data from Island Areas.

```{r}

# Calculating the number of deaths per thousand people according to the region using the regression model
lreg <- finaldata %>%
  select(region, Population) %>%
  mutate(
    y = case_when(
      region == 'East South Central' ~ 11.996 - 1.558 * log10(Population),
      region == 'East Middle' ~ 4.586,
      region == 'West South Central' ~ 8.986 - 0.944 * log10(Population),
      region == 'New England' ~ -4.129 + 1.29 * log10(Population),
      region == 'South-Atlantic' ~ 9.944 - 1.211 * log10(Population),
      region == 'East North Central' ~ 6.873 - 0.642 * log10(Population),
      region == 'West North Central' ~ 7.491 - 0.843 * log10(Population),
      .default = 2.46)
    )

# Add linear regression model results 
finaldata$y = lreg$y

# Plot data and the linear regression results 
ggplot(data = finaldata) +
  geom_point(
    aes(x = log10(Population),
        y = deaths.per.thou)) +
  geom_line(
    aes(x = log10(Population),
        y = y,
        color = 'red')) +
  facet_wrap(.~ region,
             ncol = 5) +
  theme(panel.background = element_rect(fill = 'gray'),
        panel.grid.major = element_blank(),
        axis.line = element_line(color = 'black'),
        legend.position = 'none') +
  ylab('Deaths per thousand people') +
  xlab('log10(Population)') +
  ggtitle('Deaths associated to Covid-19 per thousand of people per Population') 

```

# Conclusion

The number of deaths by Covid-9 per thousand of people decreases as the population size increases in counties located in East North Central, East South Central, South Atlantic, West North Central and West South Central, meanwhile it increases with the population size in the counties located in New England. In the rest of the regions, the population size does not seem to be a variable affecting the deaths caused by Covid-19 per thousand of people.

# Bias Identification

Another factors that I did not consider in my analysis like proximity to hospital of high complexity, age distribution, political affiliation could be important in modelling the distribution of death associated by Covid-19.

I did study vaccination rates and presence of higher institution in the county but they did not seem to correlate. I did not include that analysis to avoid making the report too long.

# R and System information

```{r}

sessionInfo()

```

# Appendix

The following code identified the counties with mistakes (when the cumulative death number of one day is smaller than the day before for that county):

```{r, eval = FALSE}

deaths <- read_csv('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv') %>%
    select(!c('UID',
              'iso2',
              'iso3',
              'code3',
              'FIPS',
              'Lat',
              'Long_',
              'Country_Region',
              'Combined_Key'))  %>%
    rename(State = 'Province_State') %>%
    group_by(State, Admin2)%>%
    summarize(across(,sum), .groups = 'drop') %>%
  pivot_longer(cols = -c('State', 'Admin2','Population'),
               names_to = 'date',
               values_to = 'deaths') %>%
  mutate(date = as.Date(date,
                        tz = '',
                        tryFormats = '%m/%d/%y'))  

mistakes <- mortality %>%
  filter(!Population == 0) %>%
  group_by(State, Admin2) %>%
  mutate(
    lag.death = lag(count),
    new.death =  count - lag.death
  ) %>%
  filter(!date == 2020-01-22) %>%
  filter(new.death < 0)

admin2 <-  mortality %>%
  select(State, Admin2) %>%
  distinct()

admin2mistakes = unique(mistakes$Admin2)

```